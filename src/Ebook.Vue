<template>
  <div class="ebook">
    <!-- æ³¨æ„ç»„ä»¶çš„åç§° -->
    <title-bar :ifTitleAndMenuShow="ifTitleAndMenuShow"></title-bar>
    <menu-bar :ifTitleAndMenuShow="ifTitleAndMenuShow" :fontSizeList="fontSizeList" 
    :defaultFontSize="defaultFontSize" @setFontSize="setFontSize" :themeList="themeList" 
    :defaultTheme="defaultTheme" @setTheme="setTheme" :bookAvailable="bookAvailable" 
    @onProgressChange="onProgressChange" @jumpTo="jumpTo" :navigation="navigation" ref="menuBar"></menu-bar>
    <div class="read-wrapper">
      <div id="read"></div>
      <!-- åŠ å…¥æµ®å±‚ï¼Œå®ç°ä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µ -->
      <div class="mask" >
        <div class="left" @click="prevPage"></div>
        <div class="center" @click="toggleTitleAndMenu"></div>
        <div class="right" @click="nextPage"></div>
      </div>
    </div>
  
  </div>
</template>

<script>
//å¼•å…¥titlebarå’Œmenubarç»„ä»¶
import TitleBar from '@/components/TitleBar'
import MenuBar from '@/components/MenuBar'
//å°†é˜…è¯»å™¨å¼•æ“å¯¼å…¥åˆ°Ebookä¸­
import Epub from 'epubjs'
//æŒ‡å‘ç”µå­ä¹¦çš„ä¸‹è½½è·¯å¾„
const DOWNLOAD_URL = '/static/2018_Book_AgileProcessesInSoftwareEngine.epub';
global.epub = Epub;
/*eslint-disable space-before-function-paren */
export default {
  components:{
    //æ³¨å†Œç»„ä»¶
    TitleBar,
    MenuBar
  },
  data(){
    return {
      ifTitleAndMenuShow: false,
      //ç”¨æ¥è¡¨ç¤ºæ‰€æœ‰çš„å­—å·
      fontSizeList: [
        //å­—å·åŠ 2
        {fontSize: 12},
        {fontSize: 14},
        {fontSize: 16},
        {fontSize: 18},
        {fontSize: 20},
        {fontSize: 22},
        {fontSize: 24}
      ],
      defaultFontSize: 16,
      themeList: [
        {
          name: 'default',
          style: {
            body:{
              //æ ·å¼ä½œç”¨äºbody
              'color': '#000',
              'background': '#fff'
            }
          }
        },
        {
          name: 'eye',
          style: {
            body:{
              //æ ·å¼ä½œç”¨äºbody
              'color': '#000',
              'background': '#ceeaba'
            }
          }
        },
        {
          name: 'night',
          style: {
            body:{
              //æ ·å¼ä½œç”¨äºbody
              'color': '#fff',
              'background': '#000'
            }
          }
        },
        {
          name: 'gold',
          style: {
            body:{
              //æ ·å¼ä½œç”¨äºbody
              'color': '#000',
              'background': 'rgb(241, 236, 226)'
            }
          }
        }

      ],
      //è¿™é‡Œç”¨çš„æ˜¯æ•°ç»„çš„åºå·
      defaultTheme: 0,
      //å›¾ä¹¦æ˜¯å¦å¤„äºå¯ç”¨çŠ¶æ€
      bookAvailable: false
    }
  },
  methods:{
    
    jumpTo(href){
      //æ ¹æ®é“¾æ¥è·³è½¬åˆ°æŒ‡å®šçš„ä½ç½® å®ç°ç›®å½•åŠŸèƒ½
      this.rendition.display(href);
      this.hideTitleAndMenun();//è·³è½¬çš„æ—¶å€™ä¼šè‡ªåŠ¨éšè—æ ‡é¢˜æ å’Œèœå•æ 
    },
    hideTitleAndMenun(){
      //éšè—æ ‡é¢˜å’Œèœå•æ 
      this.ifTitleAndMenuShow = false;
      this.$refs.menuBar.hideSetting();
      this.$refs.menuBar.hideContent();
    },
    onProgressChange(progress){
      //è¿›åº¦æ¡å˜åŒ–æ—¶è°ƒç”¨ progressæ˜¯ä¸€ä¸ªæ•°å€¼(0-100)
      //å°†progresså˜æˆç™¾åˆ†æ¯”
      const percentage = progress / 100;
      //å»è·å–å½“å‰çš„é¡µæ•° 
      const location = percentage > 0 ? this.locations.cfiFromPercentage(percentage) : 0;
      this.rendition.display(location);

    },
    setTheme(index){
      this.themes.select(this.themeList[index].name);
      this.defaultTheme = index;
    },
    registerTheme(){
      //æ³¨å†Œä¸»é¢˜

      //éå†æ•°ç»„
      this.themeList.forEach(theme => {
        this.themes.register(theme.name, theme.style);
      });
    },
     setFontSize(fontSize){
       this.defaultFontSize = fontSize;
        //1. è·å–Themeå¯¹è±¡
        if(this.themes){
          this.themes.fontSize(fontSize + 'px');//è¿™é‡Œçš„fontSizeæ˜¯æ•°å­—å‹çš„ æ‰€ä»¥è¦åœ¨åé¢åŠ ä¸Špxå˜æˆstringç±»å‹
        }
      },
    toggleTitleAndMenu(){
      //ç‚¹å‡»æ˜¾ç¤ºéšè—æ ‡é¢˜å’Œèœå•æ 
      this.ifTitleAndMenuShow = !this.ifTitleAndMenuShow;
      if(!this.ifTitleAndMenuShow){
        //å¦‚æœæ ‡é¢˜å’Œèœå•æ æ˜¯éšè—çš„ï¼Œé‚£ä¹ˆå°±è°ƒç”¨MenuBarä¸­çš„hideSettingæ–¹æ³•
        //ä¸‹é¢è¿™ä¸ªç›¸å½“äºDOMä¸­é€‰æ‹©å…ƒç´ ï¼Œä»è€Œä½¿ç”¨å¯¹åº”çš„æ–¹æ³•
        this.$refs.menuBar.hideSetting();
      }
    },
    prevPage(){
      //ç¿»åˆ°ä¸Šä¸€é¡µ é€šè¿‡rendition.prev
      if(this.rendition){
        //å¦‚æœrenditionå¯¹è±¡å­˜åœ¨ï¼Œåˆ™è°ƒç”¨å®ƒçš„prevæ–¹æ³• 
        this.rendition.prev();
      }
    },
    nextPage(){
      if(this.rendition){
        this.rendition.next();
      }
    },
    showEpub(){
      //ç”µå­ä¹¦çš„è§£æå’Œæ¸²æŸ“
      //1.ç”Ÿæˆbookå¯¹è±¡ 2.é€šè¿‡bookå¯¹è±¡å£°ç§°Renditionå¯¹è±¡ï¼Œ3.é€šè¿‡Rendition.displayæ¸²æŸ“ç”µå­ä¹¦
      this.book = new Epub(DOWNLOAD_URL);
      //Renditionå¯¹è±¡é€šè¿‡bookå¯¹è±¡çš„renderToç”Ÿæˆçš„ ('Domå¯¹è±¡çš„id',å……æ»¡å…¨å± )
      this.rendition = this.book.renderTo('read', {
        width: window.innerWidth,
        height: window.innerHeight
      });
      //æ¸²æŸ“
      this.rendition.display();

      //1. è·å–Themeå¯¹è±¡
      this.themes = this.rendition.themes;
      //è®¾ç½®é»˜è®¤å­—ä½“
      this.setFontSize(this.defaultFontSize);
      //this.themes.register(name, styles)ç”¨æ¥è®¾ç½®ä¸»é¢˜ï¼Œå‚æ•°ï¼šï¼ˆåç§°ï¼Œæ ·å¼ï¼‰
      //this.themes.select(name)é€šè¿‡ä¸»é¢˜çš„åç§°åˆ‡æ¢ä¸»é¢˜
      this.registerTheme();
      //è®¾ç½®é»˜è®¤æ ·å¼
      this.setTheme(this.defaultTheme);
      //è·å–locationså¯¹è±¡ å®ç°è¿›åº¦æ¡çš„åŠŸèƒ½ é»˜è®¤ä¸ä¼šç”Ÿæˆlocation æ¯”è¾ƒè€—å†…å­˜ soğŸ‘‡
      //é€šè¿‡epubçš„é’©å­å‡½æ•°æ¥å®ç° ready--->ç”µå­ä¹¦è§£æå®Œæˆåä¼šè°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªpromiseå¯¹è±¡
      //epubcfi ç”¨æ¥å®šä½
      this.book.ready.then(()=>{
        //è·å–ç›®å½• tocä¸‹æ˜¯ç›®å½•çš„ä¿¡æ¯
       this.navigation = this.book.navigation;
       return this.book.locations.generate();
      }).then(result => {
        //å°†å®ƒå­˜å…¥æœ¬åœ°çš„locationså˜é‡ä¸­
        this.locations = this.book.locations;
        //é»˜è®¤å›¾ä¹¦ä¸å¯ç”¨ å½“locationså¯¹è±¡ç”Ÿæˆä»¥åï¼Œè®¾ç½®ä¸ºtrue
        this.bookAvailable = true;
        
      });

      
    }
  },
  mounted(){
    //ç¬¬å››ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œè¡¨ç¤ºå†…å­˜ä¸­çš„æ¨¡ç‰ˆä»¥æ”¾ç½®åˆ°é¡µé¢ä¸­ï¼Œç”¨æˆ·çœ‹åˆ°å·²æ¸²æŸ“å¥½çš„é¡µé¢ã€‚æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°ï¼Œè¡¨ç¤ºVueå®ä¾‹åˆå§‹åŒ–å·²ç»å®Œæˆäº†

    this.showEpub();
  }
  
}
</script>

<style lang="scss" scoped>
@import 'assets/styles/global';

.ebook{
  position: relative;
  
  .read-wrapper{
    .mask{
      //å­ç»çˆ¶ç›¸
      position: absolute;
      top: 0;
      left: 0;
      display: flex;
      width: 100%;
      height: 100%;
      z-index: 100;
      // background-color: yellow;

      //é‡‡ç”¨å¼¹æ€§å¸ƒå±€ è®©ä»–ä»¬æ°´å¹³æ’åˆ—
      .left{
        //å·¦è¾¹100px
        flex: 0 0 px2rem(100);
        
      }
      .center{
        //ä¸­é—´å¡«å……æ»¡
        flex: 1;
        

      }
      .right{
        flex: 0 0 px2rem(100);
        
      }

    }
  }

 
}
</style>
